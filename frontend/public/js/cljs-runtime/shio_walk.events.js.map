{"version":3,"sources":["shio_walk/events.cljs"],"mappings":"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","names":["re_frame.core.reg_event_db","_","stored-token","js/localStorage","stored-user","G__12405","shio-walk.db/default-db","cljs.core.assoc","cljs.core.js__GT_clj","js/JSON","p__12406","vec__12407","cljs.core.nth","db","error","p__12410","vec__12411","loading?","p__12414","vec__12415","page","p__12420","vec__12421","user-data","p1__12418#","p1__12419#","shio-walk.api/register","re-frame.core/dispatch","or__5002__auto__","p__12424","vec__12425","response","cljs.core/clj->js","p__12430","vec__12431","credentials","p1__12428#","p1__12429#","shio-walk.api/login","p__12434","vec__12435","token","p1__12438#","shio-walk.api/get-stats","p__12439","vec__12440","stats","p1__12443#","shio-walk.api/get-walks","p__12445","vec__12446","walks","active-walk","cljs.core/first","p1__12444#","cljs.core.filter","cljs.core._EQ_","p1__12449#","shio-walk.api/get-rewards","p__12450","vec__12451","rewards","p1__12454#","shio-walk.api/get-unlocked-rewards","p__12455","vec__12456","unlocked-rewards","p1__12459#","shio-walk.api/start-walk","p__12460","vec__12461","walk","p__12465","vec__12466","walk-id","data","p1__12464#","shio-walk.api/update-walk","p__12469","vec__12470","p__12474","vec__12475","p1__12473#","shio-walk.api/complete-walk","p__12478","vec__12479","result","cljs.core/seq","js/alert","clojure.string.join","cljs.core.map","cljs.core.update","cljs.core/merge"],"sourcesContent":["(ns shio-walk.events\n  (:require [re-frame.core :as rf]\n            [shio-walk.db :as db]\n            [shio-walk.api :as api]))\n\n;; \u521d\u671f\u5316\n(rf/reg-event-db\n :initialize-db\n (fn [_ _]\n   (let [stored-token (.getItem js/localStorage \"token\")\n         stored-user (.getItem js/localStorage \"user\")]\n     (cond-> db/default-db\n       stored-token (assoc :token stored-token)\n       stored-user (assoc :user (js->clj (.parse js/JSON stored-user) :keywordize-keys true))\n       stored-token (assoc :current-page :dashboard)))))\n\n;; \u30a8\u30e9\u30fc\u51e6\u7406\n(rf/reg-event-db\n :set-error\n (fn [db [_ error]]\n   (assoc db :error error :loading? false)))\n\n(rf/reg-event-db\n :clear-error\n (fn [db _]\n   (assoc db :error nil)))\n\n;; \u30ed\u30fc\u30c7\u30a3\u30f3\u30b0\u72b6\u614b\n(rf/reg-event-db\n :set-loading\n (fn [db [_ loading?]]\n   (assoc db :loading? loading?)))\n\n;; \u30da\u30fc\u30b8\u9077\u79fb\n(rf/reg-event-db\n :set-page\n (fn [db [_ page]]\n   (assoc db :current-page page :error nil)))\n\n;; \u8a8d\u8a3c\u95a2\u9023\n(rf/reg-event-db\n :register\n (fn [db [_ user-data]]\n   (api/register\n    user-data\n    #(rf/dispatch [:register-success %])\n    #(rf/dispatch [:set-error (or (:message %) \"\u767b\u9332\u306b\u5931\u6557\u3057\u307e\u3057\u305f\")]))\n   (assoc db :loading? true :error nil)))\n\n(rf/reg-event-db\n :register-success\n (fn [db [_ response]]\n   (.setItem js/localStorage \"token\" (:token response))\n   (.setItem js/localStorage \"user\" (.stringify js/JSON (clj->js (:user response))))\n   (rf/dispatch [:load-initial-data])\n   (-> db\n       (assoc :token (:token response)\n              :user (:user response)\n              :loading? false\n              :current-page :dashboard))))\n\n(rf/reg-event-db\n :login\n (fn [db [_ credentials]]\n   (api/login\n    credentials\n    #(rf/dispatch [:login-success %])\n    #(rf/dispatch [:set-error (or (:message %) \"\u30ed\u30b0\u30a4\u30f3\u306b\u5931\u6557\u3057\u307e\u3057\u305f\")]))\n   (assoc db :loading? true :error nil)))\n\n(rf/reg-event-db\n :login-success\n (fn [db [_ response]]\n   (.setItem js/localStorage \"token\" (:token response))\n   (.setItem js/localStorage \"user\" (.stringify js/JSON (clj->js (:user response))))\n   (rf/dispatch [:load-initial-data])\n   (-> db\n       (assoc :token (:token response)\n              :user (:user response)\n              :loading? false\n              :current-page :dashboard))))\n\n(rf/reg-event-db\n :logout\n (fn [_ _]\n   (.removeItem js/localStorage \"token\")\n   (.removeItem js/localStorage \"user\")\n   (assoc db/default-db :current-page :login)))\n\n;; \u30c7\u30fc\u30bf\u8aad\u307f\u8fbc\u307f\n(rf/reg-event-db\n :load-initial-data\n (fn [db _]\n   (rf/dispatch [:load-stats])\n   (rf/dispatch [:load-walks])\n   (rf/dispatch [:load-rewards])\n   (rf/dispatch [:load-unlocked-rewards])\n   db))\n\n(rf/reg-event-db\n :load-stats\n (fn [db _]\n   (let [token (:token db)]\n     (api/get-stats\n      token\n      #(rf/dispatch [:stats-loaded %])\n      #(rf/dispatch [:set-error \"\u7d71\u8a08\u60c5\u5831\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n     db)))\n\n(rf/reg-event-db\n :stats-loaded\n (fn [db [_ stats]]\n   (assoc db :stats stats)))\n\n(rf/reg-event-db\n :load-walks\n (fn [db _]\n   (let [token (:token db)]\n     (api/get-walks\n      token\n      #(rf/dispatch [:walks-loaded %])\n      #(rf/dispatch [:set-error \"\u30a6\u30a9\u30fc\u30af\u5c65\u6b74\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n     db)))\n\n(rf/reg-event-db\n :walks-loaded\n (fn [db [_ walks]]\n   (let [active-walk (first (filter #(= (:status %) \"active\") walks))]\n     (assoc db \n            :walks walks\n            :current-walk active-walk))))\n\n(rf/reg-event-db\n :load-rewards\n (fn [db _]\n   (let [token (:token db)]\n     (api/get-rewards\n      token\n      #(rf/dispatch [:rewards-loaded %])\n      #(rf/dispatch [:set-error \"\u5831\u916c\u4e00\u89a7\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n     db)))\n\n(rf/reg-event-db\n :rewards-loaded\n (fn [db [_ rewards]]\n   (assoc db :rewards rewards)))\n\n(rf/reg-event-db\n :load-unlocked-rewards\n (fn [db _]\n   (let [token (:token db)]\n     (api/get-unlocked-rewards\n      token\n      #(rf/dispatch [:unlocked-rewards-loaded %])\n      #(rf/dispatch [:set-error \"\u7372\u5f97\u6e08\u307f\u5831\u916c\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n     db)))\n\n(rf/reg-event-db\n :unlocked-rewards-loaded\n (fn [db [_ unlocked-rewards]]\n   (assoc db :unlocked-rewards unlocked-rewards)))\n\n;; \u30a6\u30a9\u30fc\u30af\u64cd\u4f5c\n(rf/reg-event-db\n :start-walk\n (fn [db _]\n   (let [token (:token db)]\n     (api/start-walk\n      token\n      #(rf/dispatch [:walk-started %])\n      #(rf/dispatch [:set-error \"\u30a6\u30a9\u30fc\u30af\u306e\u958b\u59cb\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n     (assoc db :loading? true))))\n\n(rf/reg-event-db\n :walk-started\n (fn [db [_ walk]]\n   (rf/dispatch [:load-walks])\n   (assoc db :current-walk walk :loading? false)))\n\n(rf/reg-event-db\n :update-walk\n (fn [db [_ walk-id data]]\n   (let [token (:token db)]\n     (api/update-walk\n      token\n      walk-id\n      data\n      #(rf/dispatch [:walk-updated %])\n      #(rf/dispatch [:set-error \"\u30a6\u30a9\u30fc\u30af\u306e\u66f4\u65b0\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n     db)))\n\n(rf/reg-event-db\n :walk-updated\n (fn [db [_ walk]]\n   (assoc db :current-walk walk)))\n\n(rf/reg-event-db\n :complete-walk\n (fn [db [_ walk-id]]\n   (let [token (:token db)]\n     (api/complete-walk\n      token\n      walk-id\n      #(rf/dispatch [:walk-completed %])\n      #(rf/dispatch [:set-error \"\u30a6\u30a9\u30fc\u30af\u306e\u5b8c\u4e86\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n     (assoc db :loading? true))))\n\n(rf/reg-event-db\n :walk-completed\n (fn [db [_ result]]\n   (rf/dispatch [:load-walks])\n   (rf/dispatch [:load-unlocked-rewards])\n   (when (seq (:new-rewards result))\n     (js/alert (str \"\u65b0\u3057\u3044\u5831\u916c\u3092\u7372\u5f97\u3057\u307e\u3057\u305f\uff01\\n\"\n                    (clojure.string/join \"\\n\" (map :title (:new-rewards result))))))\n   (-> db\n       (assoc :current-walk nil :loading? false)\n       (update :stats merge (:stats result)))))\n"]}