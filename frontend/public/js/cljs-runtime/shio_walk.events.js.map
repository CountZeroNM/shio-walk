{"version":3,"sources":["shio_walk/events.cljs"],"mappings":"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","names":["re_frame.core.reg_event_fx","_","token","js/localStorage","user-str","user","and__5000__auto__","e12405","cljs.core.js__GT_clj","js/JSON","new-db","G__12406","shio-walk.db/default-db","cljs.core.assoc","re_frame.core.reg_event_db","p__12407","vec__12408","cljs.core.nth","db","err","p__12411","vec__12412","v","p__12415","vec__12416","page","p__12420","p__12421","map__12422","cljs.core/--destructure-map","cljs.core.get","vec__12423","credentials","p1__12419#","shio-walk.api/login","re-frame.core/dispatch","p__12426","vec__12427","map__12430","cljs.core/clj->js","p__12432","map__12433","p1__12431#","shio-walk.api/get-walks","p__12435","map__12436","p1__12434#","shio-walk.api/get-stats","p__12437","vec__12438","stats","p__12442","map__12443","p1__12441#","shio-walk.api/get-rewards","p__12444","vec__12445","rewards","p__12449","map__12450","p1__12448#","shio-walk.api/get-unlocked-rewards","p__12451","vec__12452","p__12456","vec__12457","walks","active","cljs.core/first","p1__12455#","cljs.core.filter","cljs.core._EQ_","G__12460","p__12461","map__12462","shio-walk.api/start-walk","p__12463","map__12464","walk","p__12465","p__12466","map__12467","vec__12468","walk-id","data","shio-walk.api/update-walk","p__12471","p__12472","map__12473","vec__12474","shio-walk.api/complete-walk","p__12477","vec__12478"],"sourcesContent":["(ns shio-walk.events\n  (:require [re-frame.core :as rf]\n            [shio-walk.db :as db]\n            [shio-walk.api :as api]))\n\n;; --------------------\n;; \u521d\u671f\u5316\n;; --------------------\n(rf/reg-event-fx\n :initialize-db\n (fn [_ _]\n   (let [token (.getItem js/localStorage \"token\")\n         user-str (.getItem js/localStorage \"user\")\n         user (when (and token user-str)\n                (try (js->clj (.parse js/JSON user-str) :keywordize-keys true)\n                     (catch :default _ nil)))\n         new-db (cond-> db/default-db\n                  token (assoc :token token)\n                  user  (assoc :user user :current-page :dashboard))]\n     (if token\n       {:db new-db\n        :dispatch [:load-initial-data]}\n       {:db new-db}))))\n\n;; --------------------\n;; \u5171\u901aUI\u72b6\u614b\n;; --------------------\n(rf/reg-event-db\n :set-error\n (fn [db [_ err]]\n   (assoc db :error err :loading? false)))\n\n(rf/reg-event-db\n :set-loading\n (fn [db [_ v]]\n   (assoc db :loading? v)))\n\n(rf/reg-event-db\n :set-page\n (fn [db [_ page]]\n   (assoc db :current-page page :error nil)))\n\n;; --------------------\n;; \u8a8d\u8a3c\n;; --------------------\n(rf/reg-event-fx\n :login\n (fn [{:keys [db]} [_ credentials]]\n   (api/login\n    credentials\n    #(rf/dispatch [:login-success %])\n    #(rf/dispatch [:set-error \"\u30ed\u30b0\u30a4\u30f3\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n   {:db (assoc db :loading? true)}))\n\n(rf/reg-event-db\n :login-success\n (fn [db [_ {:keys [token user]}]]\n   (.setItem js/localStorage \"token\" token)\n   (.setItem js/localStorage \"user\" (.stringify js/JSON (clj->js user)))\n   (rf/dispatch [:load-initial-data])\n   (assoc db\n          :token token\n          :user user\n          :loading? false\n          :current-page :dashboard)))\n\n(rf/reg-event-db\n :logout\n (fn [_ _]\n   (.removeItem js/localStorage \"token\")\n   (.removeItem js/localStorage \"user\")\n   (assoc db/default-db :current-page :login)))\n\n;; --------------------\n;; \u521d\u671f\u30c7\u30fc\u30bf\u30ed\u30fc\u30c9\n;; --------------------\n(rf/reg-event-fx\n :load-initial-data\n (fn [_ _]\n   {:dispatch-n [[:load-stats]\n                 [:load-walks]\n                 [:load-rewards]\n                 [:load-unlocked-rewards]]}))\n\n(rf/reg-event-fx\n :load-walks\n (fn [{:keys [db]} _]\n   (api/get-walks\n    (:token db)\n    #(rf/dispatch [:walks-loaded %])\n    #(rf/dispatch [:set-error \"\u30a6\u30a9\u30fc\u30af\u53d6\u5f97\u5931\u6557\"]))\n   {}))\n\n(rf/reg-event-fx\n :load-stats\n (fn [{:keys [db]} _]\n   (api/get-stats\n    (:token db)\n    #(rf/dispatch [:stats-loaded %])\n    #(rf/dispatch [:set-error \"\u7d71\u8a08\u60c5\u5831\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n   {}))\n\n(rf/reg-event-db\n :stats-loaded\n (fn [db [_ stats]]\n   (assoc db :stats stats)))\n\n(rf/reg-event-fx\n :load-rewards\n (fn [{:keys [db]} _]\n   (api/get-rewards\n    (:token db)\n    #(rf/dispatch [:rewards-loaded %])\n    #(rf/dispatch [:set-error \"\u5831\u916c\u4e00\u89a7\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n   {}))\n\n(rf/reg-event-db\n :rewards-loaded\n (fn [db [_ rewards]]\n   (assoc db :rewards rewards)))\n\n(rf/reg-event-fx\n :load-unlocked-rewards\n (fn [{:keys [db]} _]\n   (api/get-unlocked-rewards\n    (:token db)\n    #(rf/dispatch [:unlocked-rewards-loaded %])\n    #(rf/dispatch [:set-error \"\u7372\u5f97\u6e08\u307f\u5831\u916c\u306e\u53d6\u5f97\u306b\u5931\u6557\u3057\u307e\u3057\u305f\"]))\n   {}))\n\n(rf/reg-event-db\n :unlocked-rewards-loaded\n (fn [db [_ rewards]]\n   (assoc db :unlocked-rewards rewards)))\n\n(rf/reg-event-db\n :walks-loaded\n (fn [db [_ walks]]\n   (let [active (first (filter #(= (:status %) \"active\") walks))]\n     (cond-> (assoc db :walks walks :loading? false)\n       active (assoc :current-walk active)))))\n\n\n;; --------------------\n;; \u30a6\u30a9\u30fc\u30af\u64cd\u4f5c\n;; --------------------\n(rf/reg-event-fx\n :start-walk\n (fn [{:keys [db]} _]\n   (api/start-walk\n    (:token db)\n    (fn [{:keys [walk]}]\n      (rf/dispatch [:walk-started walk])\n      (rf/dispatch [:load-walks]))\n    #(rf/dispatch [:set-error \"\u958b\u59cb\u5931\u6557\"]))\n   {:db (assoc db :loading? true)}))\n\n(rf/reg-event-fx\n :update-walk\n (fn [{:keys [db]} [_ walk-id data]]\n   (api/update-walk\n    (:token db)\n    walk-id\n    data\n    (fn [_] (rf/dispatch [:load-walks]))\n    #(rf/dispatch [:set-error \"\u66f4\u65b0\u5931\u6557\"]))\n   {}))\n\n(rf/reg-event-fx\n :complete-walk\n (fn [{:keys [db]} [_ walk-id]]\n   (api/complete-walk\n    (:token db)\n    walk-id\n    (fn [_]\n      (rf/dispatch [:load-walks])\n      (rf/dispatch [:load-unlocked-rewards]))\n    #(rf/dispatch [:set-error \"\u5b8c\u4e86\u5931\u6557\"]))\n   {:db (assoc db :loading? true)}))\n\n(rf/reg-event-db\n :walk-started\n (fn [db [_ walk]]\n   (-> db\n       (assoc :current-walk walk)\n       (assoc :loading? false))))\n\n"]}