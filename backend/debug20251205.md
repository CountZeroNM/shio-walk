# shio-walk バックエンド修正レポート (2025/12/05)

## 概要

このドキュメントは、shio-walkバックエンドで発生した2つの主要な不具合とその修正内容についてまとめたものです。
修正は以下の2点です。

1.  データベース接続時の認証失敗
2.  ユーザー登録API実行時の引数エラー

---

## 1. データベース認証の失敗

### 問題の概要

サーバー起動時に環境変数を正しく設定しているにもかかわらず、PostgreSQLへの接続時に認証エラー `FATAL: password authentication failed` が発生していました。
調査の結果、アプリケーションが環境変数で指定したユーザー名ではなく、システムのOSユーザー名（例: `wiredmarks716`）で接続を試みていることが判明しました。

### 原因

この問題は、データベース接続ライブラリ（`next.jdbc` および `HikariCP`）が、接続設定として渡されたマップの `:user` キーを期待通りに解釈していなかったために発生していました。
`HikariCP` では、ユーザー名を指定するための標準的なプロパティ名は `:username` です。ライブラリが `:user` キーを認識できず、フォールバックとしてシステムのユーザー名を使用してしまったと考えられます。

### 解決策

`src/shio_walk/config.clj` ファイルを修正し、データベース設定マップに `:username` キーを追加しました。これにより、接続ライブラリが正しいユーザー名を認識できるようになりました。

**変更前のコード (`src/shio_walk/config.clj`)**
```clojure
(def config
  {:db {:dbtype "postgresql"
        :dbname (or (System/getenv "DB_NAME") "shio_walk")
        :host (or (System/getenv "DB_HOST") "localhost")
        :port (Integer/parseInt (or (System/getenv "DB_PORT") "5432"))
        :user (or (System/getenv "DB_USER") "shio_user") ; このキーが認識されていなかった
        :password (or (System/getenv "DB_PASSWORD") "shiopass")
        :maximumPoolSize 10}
   ...})
```

**変更後のコード (`src/shio_walk/config.clj`)**
```clojure
(def config
  {:db {:dbtype "postgresql"
        :dbname (or (System/getenv "DB_NAME") "shio_walk")
        :host (or (System/getenv "DB_HOST") "localhost")
        :port (Integer/parseInt (or (System/getenv "DB_PORT") "5432"))
        :user (or (System/getenv "DB_USER") "shio_user")
        :username (or (System/getenv "DB_USER") "shio_user") ; このキーを追加
        :password (or (System/getenv "DB_PASSWORD") "shiopass")
        :maximumPoolSize 10}
   ...})
```
---

## 2. ユーザー登録時の引数エラー

### 問題の概要

データベース認証の問題を解決した後、ユーザー登録API (`/api/auth/register`) を呼び出すと、サーバーが `500 Internal Server Error` を返し、ログに `Wrong number of args` というエラーが出力される問題が発生しました。

### 原因

このエラーは、`src/shio_walk/db.clj` 内で定義されていたデータベース操作のヘルパー関数 `execute-one!` が、引数を1つしか受け取らない単一アリティの関数として定義されていたことが原因でした。

一方で、ユーザーを作成する `create-user!` 関数は、SQLクエリとオプションマップ（`{ :return-keys true }`）の2つの引数で `execute-one!` を呼び出していました。これにより、関数のシグネチャと呼び出しの引数の数が一致せず、エラーが発生していました。

### 解決策

`src/shio_walk/db.clj` の `execute!` および `execute-one!` 関数を、引数が1つの場合と2つの場合の両方に対応できるよう、複数のアリティ（multi-arity）を持つように修正しました。

**変更前のコード (`src/shio_walk/db.clj`)**
```clojure
(defn execute! [sql-vec]
  (jdbc/execute! @datasource sql-vec))

(defn execute-one! [sql-vec]
  (jdbc/execute-one! @datasource sql-vec))
```

**変更後のコード (`src/shio_walk/db.clj`)**
```clojure
(defn execute!
  ([sql-vec]
   (jdbc/execute! @datasource sql-vec))
  ([sql-vec opts]
   (jdbc/execute! @datasource sql-vec opts)))

(defn execute-one!
  ([sql-vec]
   (jdbc/execute-one! @datasource sql-vec))
  ([sql-vec opts]
   (jdbc/execute-one! @datasource sql-vec opts)))
```

---

以上の修正により、データベースへの接続とユーザー登録機能が正常に動作するようになりました。
